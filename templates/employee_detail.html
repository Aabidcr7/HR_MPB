{% extends "base.html" %}

{% block title %}Employee Details - HR Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>{{ employee.name }}
                        {% if employee.get('stage','Onboarded') == 'Resigned' %}
                        <span class="badge bg-danger ms-2">Resigned</span>
                        {% else %}
                        <span class="badge bg-success ms-2">Active Employee</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Employee ID:</strong> EMP{{ employee.id }}</p>
                            <p><strong>Name:</strong> {{ employee.name }}</p>
                            <p><strong>Email:</strong> {{ employee.email }}</p>
                            <p><strong>Phone:</strong> {{ employee.phone }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Department:</strong> {{ employee.get('department', 'N/A') }}</p>
                            <p><strong>Position:</strong> {{ employee.get('position', employee.get('job_title', 'N/A')) }}</p>
                            <p><strong>Join Date:</strong> {{ employee.get('joining_date', employee.applied_date.split()[0] if employee.applied_date else 'N/A') }}</p>
                            <p><strong>Experience:</strong> {{ employee.experience }} years</p>
                        </div>
                    </div>
                    
                    {% if employee.get('skills') %}
                    <div class="mt-3">
                        <h6>Skills & Expertise:</h6>
                        <p class="text-muted">{{ employee.skills }}</p>
                    </div>
                    {% endif %}
                    
                    {% if employee.get('salary') and employee.get('salary') != 'N/A' %}
                    <div class="mt-3">
                        <h6>Salary Information:</h6>
                        <p class="text-muted">Annual Salary: ₹{{ "{:,.2f}".format(employee.salary|float) if employee.salary and employee.salary != 'N/A' else 'N/A' }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Offer Information -->
            {% if employee.get('job_title') and employee.get('job_title') != 'N/A' %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-contract me-2"></i>Offer Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Original Position:</strong> {{ employee.get('position', 'N/A') }}</p>
                            <p><strong>Offer Job Title:</strong> {{ employee.get('job_title', 'N/A') }}</p>
                            <p><strong>Department:</strong> {{ employee.get('department', 'N/A') }}</p>
                            <p><strong>Work Location:</strong> {{ employee.get('location', 'N/A') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Annual Salary:</strong> ₹{{ "{:,.2f}".format(employee.salary|float) if employee.salary and employee.salary != 'N/A' else 'N/A' }}</p>
                            <p><strong>Joining Date:</strong> {{ employee.get('joining_date', 'N/A') }}</p>
                            <p><strong>Offer Date:</strong> {{ employee.get('offer_date', 'N/A').split()[0] if employee.get('offer_date') and employee.get('offer_date') != 'N/A' else 'N/A' }}</p>
                        </div>
                    </div>
                    
                    {% if employee.get('benefits') and employee.get('benefits') != 'N/A' %}
                    <div class="mt-3">
                        <h6>Benefits & Perks:</h6>
                        <p class="text-muted">{{ employee.benefits }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            
            {% if employee.resume_filename %}
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-pdf me-2"></i>Resume</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleEmployeeResumePreview()">
                            <i class="fas fa-eye me-1"></i>Toggle Preview
                        </button>
                        <a href="{{ url_for('get_resume', cand_id=employee.id) }}" class="btn btn-outline-secondary btn-sm" download>
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div id="employeeResumePreview" style="display: none;">
                        <div class="text-center">
                            {% set file_ext = employee.resume_filename.lower().split('.')[-1] %}
                            {% if file_ext == 'pdf' %}
                                <iframe src="{{ url_for('preview_resume', cand_id=employee.id) }}" 
                                        width="100%" 
                                        height="600px" 
                                        style="border: 1px solid #ddd; border-radius: 5px;"
                                        type="application/pdf">
                                    <p>Your browser does not support PDF viewing. 
                                       <a href="{{ url_for('get_resume', cand_id=employee.id) }}" target="_blank">Click here to download the resume</a>
                                    </p>
                                </iframe>
                            {% elif file_ext in ['doc', 'docx'] %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Word documents cannot be previewed inline. 
                                    <a href="{{ url_for('get_resume', cand_id=employee.id) }}" target="_blank" class="btn btn-primary btn-sm ms-2">
                                        <i class="fas fa-download me-1"></i>Download to View
                                    </a>
                                </div>
                            {% elif file_ext == 'txt' %}
                                <iframe src="{{ url_for('preview_resume', cand_id=employee.id) }}" 
                                        width="100%" 
                                        height="400px" 
                                        style="border: 1px solid #ddd; border-radius: 5px;">
                                    <p>Your browser does not support text viewing. 
                                       <a href="{{ url_for('get_resume', cand_id=employee.id) }}" target="_blank">Click here to download the resume</a>
                                    </p>
                                </iframe>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    This file type cannot be previewed. 
                                    <a href="{{ url_for('get_resume', cand_id=employee.id) }}" target="_blank" class="btn btn-primary btn-sm ms-2">
                                        <i class="fas fa-download me-1"></i>Download to View
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div id="employeeResumeInfo">
                        <p class="text-muted">
                            <i class="fas fa-file-pdf me-2"></i>
                            Resume file: <strong>{{ employee.resume_filename }}</strong>
                        </p>
                        <p class="text-muted">Click "Toggle Preview" to view the resume inline or "Download" to save it.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Signed Offer Letter -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-signature me-2"></i>Signed Offer Letter</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleSignedOfferPreview()">
                            <i class="fas fa-eye me-1"></i>Toggle Preview
                        </button>
                        <a href="{{ url_for('download_signed_offer', cand_id=employee.id) }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% set signed_offer = None %}
                    {% set _ = signed_offer %}
                    {% set has_file = False %}
                    {% if employee.get('signed_offer_filename') %}
                        {% set has_file = True %}
                    {% endif %}

                    <div id="signedOfferPreview" style="display: none;">
                        {% if has_file %}
                            {% set file_ext = employee.get('signed_offer_filename').lower().split('.')[-1] %}
                            {% if file_ext == 'pdf' %}
                                <iframe src="{{ url_for('preview_signed_offer', cand_id=employee.id) }}" width="100%" height="600px" style="border:1px solid #ddd; border-radius:5px;"></iframe>
                            {% elif file_ext in ['doc','docx'] %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Word documents cannot be previewed inline. Please download to view.
                                </div>
                            {% elif file_ext == 'txt' %}
                                <iframe src="{{ url_for('preview_signed_offer', cand_id=employee.id) }}" width="100%" height="400px" style="border:1px solid #ddd; border-radius:5px;"></iframe>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    This file type cannot be previewed.
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-secondary mb-0">
                                No signed offer letter uploaded yet.
                            </div>
                        {% endif %}
                    </div>
                    <div id="signedOfferInfo">
                        {% if has_file %}
                        <p class="text-muted mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            File: <strong>{{ employee.get('signed_offer_filename') }}</strong>
                        </p>
                        {% else %}
                        <p class="text-muted mb-0">No signed offer letter on file.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Resignation Documents (if resigned) -->
            {% if employee.get('stage') == 'Resigned' %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Resignation Documents</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Resignation Letter</strong>
                            {% if employee.get('resignation_letter_filename') %}
                                <div class="text-muted small">{{ employee.get('resignation_letter_filename') }}</div>
                            {% else %}
                                <div class="text-muted small">Not uploaded</div>
                            {% endif %}
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleResignDoc('resignation_letter')"><i class="fas fa-eye me-1"></i>Toggle Preview</button>
                            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_resignation_doc', cand_id=employee.id, doc_type='resignation_letter') }}"><i class="fas fa-download me-1"></i>Download</a>
                        </div>
                    </div>
                    <div id="preview_resignation_letter" style="display:none" class="mb-3"></div>

                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Acceptance Letter</strong>
                            {% if employee.get('acceptance_letter_filename') %}
                                <div class="text-muted small">{{ employee.get('acceptance_letter_filename') }}</div>
                            {% else %}
                                <div class="text-muted small">Not uploaded</div>
                            {% endif %}
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleResignDoc('acceptance_letter')"><i class="fas fa-eye me-1"></i>Toggle Preview</button>
                            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_resignation_doc', cand_id=employee.id, doc_type='acceptance_letter') }}"><i class="fas fa-download me-1"></i>Download</a>
                        </div>
                    </div>
                    <div id="preview_acceptance_letter" style="display:none" class="mb-3"></div>

                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Relieving Letter</strong>
                            {% if employee.get('relieving_letter_filename') %}
                                <div class="text-muted small">{{ employee.get('relieving_letter_filename') }}</div>
                            {% else %}
                                <div class="text-muted small">Not uploaded</div>
                            {% endif %}
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleResignDoc('relieving_letter')"><i class="fas fa-eye me-1"></i>Toggle Preview</button>
                            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('download_resignation_doc', cand_id=employee.id, doc_type='relieving_letter') }}"><i class="fas fa-download me-1"></i>Download</a>
                        </div>
                    </div>
                    <div id="preview_relieving_letter" style="display:none" class="mb-3"></div>
                </div>
            </div>
            {% endif %}

            <!-- Employee Actions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Employee Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{{ url_for('resignation_form', cand_id=employee.id) }}" class="btn btn-danger w-100">
                                <i class="fas fa-sign-out-alt me-2"></i>Process Resignation
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('employees_page') }}" class="btn btn-secondary w-100">
                                <i class="fas fa-arrow-left me-2"></i>Back to Employees
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Employee Stats -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Employee Summary</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="border rounded p-3 mb-3">
                            <h4 class="text-primary">{{ employee.experience }}</h4>
                            <small class="text-muted">Years Experience</small>
                        </div>
                        <div class="border rounded p-3 mb-3">
                            <h4 class="text-success">{{ employee.get('department', 'N/A') }}</h4>
                            <small class="text-muted">Department</small>
                        </div>
                        <div class="border rounded p-3">
                            <h4 class="text-info">Active</h4>
                            <small class="text-muted">Employment Status</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employment History -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Employment Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% if employee.get('offer_date') and employee.get('offer_date') != 'N/A' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Offer Extended</h6>
                                <small class="text-muted">{{ employee.get('offer_date', 'N/A').split()[0] if employee.get('offer_date') and employee.get('offer_date') != 'N/A' else 'N/A' }}</small>
                            </div>
                        </div>
                        {% endif %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Joined Company</h6>
                                <small class="text-muted">{{ employee.get('joining_date', employee.applied_date.split()[0] if employee.applied_date else 'N/A') }}</small>
                            </div>
                        </div>
                        {% if employee.requisition_id != '0' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Recruited via Requisition</h6>
                                <small class="text-muted">REQ-{{ employee.requisition_id }}</small>
                            </div>
                        </div>
                        {% else %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Direct Hire</h6>
                                <small class="text-muted">Added directly to system</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -23px;
    top: 5px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-content {
    background: #f8f9fa;
    padding: 10px 15px;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}
</style>
{% endblock %}

<script>
function toggleEmployeeResumePreview() {
    const preview = document.getElementById('employeeResumePreview');
    const info = document.getElementById('employeeResumeInfo');
    const button = event.target.closest('button');
    if (preview && info && button) {
        if (preview.style.display === 'none' || preview.style.display === '') {
            preview.style.display = 'block';
            info.style.display = 'none';
            button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Preview';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
        } else {
            preview.style.display = 'none';
            info.style.display = 'block';
            button.innerHTML = '<i class="fas fa-eye me-1"></i>Toggle Preview';
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-primary');
        }
    }
}

function toggleSignedOfferPreview() {
    const preview = document.getElementById('signedOfferPreview');
    const info = document.getElementById('signedOfferInfo');
    const button = event.target.closest('button');
    if (preview && info && button) {
        if (preview.style.display === 'none' || preview.style.display === '') {
            preview.style.display = 'block';
            info.style.display = 'none';
            button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Preview';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
        } else {
            preview.style.display = 'none';
            info.style.display = 'block';
            button.innerHTML = '<i class="fas fa-eye me-1"></i>Toggle Preview';
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-primary');
        }
    }
}

function toggleResignDoc(type) {
    const el = document.getElementById(`preview_${type}`);
    if (!el) return;
    if (el.dataset.loaded !== '1') {
        // Lazy load iframe
        el.innerHTML = `<iframe src="${type === 'resignation_letter' ? '{{ url_for('preview_resignation_doc', cand_id=employee.id, doc_type='resignation_letter') }}' : (type === 'acceptance_letter' ? '{{ url_for('preview_resignation_doc', cand_id=employee.id, doc_type='acceptance_letter') }}' : '{{ url_for('preview_resignation_doc', cand_id=employee.id, doc_type='relieving_letter') }}')}" width="100%" height="500px" style="border:1px solid #ddd; border-radius:5px;"></iframe>`;
        el.dataset.loaded = '1';
    }
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
}
</script>